<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ø±Ø¯Ùˆ Ú©ÛØ§Ù†ÛŒ Ø³Ù†Ø§Ù†Û’ ÙˆØ§Ù„Ø§</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    input, button { padding: 10px; margin: 6px; font-size: 1rem; }
    #storyText { margin-top: 18px; font-size: 1.15rem; white-space: pre-wrap; }
    .mic-btn { border: none; background: none; font-size: 2.2rem; cursor: pointer; margin: 10px; }
    .mic-btn.glow { color: #e11d48; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { text-shadow: 0 0 6px #e11d48; } 50% { text-shadow: 0 0 24px #e11d48; } 100% { text-shadow: 0 0 6px #e11d48; } }
    .muted { opacity: 0.7; }
  </style>
</head>
<body>
  <h2>Ø§Ù¾Ù†ÛŒ Ú©ÛØ§Ù†ÛŒ Ú©Ø§ Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº ÛŒØ§ Ø¨ÙˆÙ„ÛŒÚº</h2>

  <input type="text" id="title" placeholder="Ú©ÛØ§Ù†ÛŒ Ú©Ø§ Ø¹Ù†ÙˆØ§Ù† Ù„Ú©Ú¾ÛŒÚº" />
  <button id="genBtn">Ú©ÛØ§Ù†ÛŒ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
  <br />
  <button class="mic-btn" id="micBtn" title="Ø¨ÙˆÙ„ÛŒÚº">ğŸ¤</button>
  <div id="listenHint" class="muted" style="display:none;">ğŸ”Š Ø³Ù† Ø±ÛØ§ ÛÙˆÚºâ€¦</div>

  <h3>ğŸ“– Ú©ÛØ§Ù†ÛŒ</h3>
  <div id="storyText"></div>

  <h3>ğŸ”Š Ø¢ÚˆÛŒÙˆ</h3>
  <audio id="storyAudio" controls></audio>

  <script>
    const backendUrl = "http://3.91.184.138:8000";

    const titleEl = document.getElementById("title");
    const storyEl = document.getElementById("storyText");
    const audioEl = document.getElementById("storyAudio");
    const micBtn  = document.getElementById("micBtn");
    const listenHint = document.getElementById("listenHint");
    const genBtn  = document.getElementById("genBtn");

    genBtn.addEventListener("click", generateStory);
    micBtn.addEventListener("click", startListening);

    async function generateStory() {
      const title = titleEl.value.trim();
      if (!title) { alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”"); return; }

      storyEl.textContent = "Ú©ÛØ§Ù†ÛŒ Ø¨Ù† Ø±ÛÛŒ ÛÛ’â€¦ Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±ÛŒÚºÛ”";
      audioEl.removeAttribute("src");

      const formData = new FormData();
      formData.append("title", title);

      try {
        const res = await fetch(`${backendUrl}/story`, { method: "POST", body: formData });
        if (!res.ok) throw new Error("API error " + res.status);
        const data = await res.json();

        storyEl.textContent = data.text || "(Ù…ØªÙ† Ø¯Ø³ØªÛŒØ§Ø¨ Ù†ÛÛŒÚº)";
        audioEl.src = `${backendUrl}/audio/${data.audio}`;
        audioEl.play().catch(()=>{}); // autoplay may be blocked; user can press play
      } catch (e) {
        console.error(e);
        alert("Ú©Ú†Ú¾ ØºÙ„Ø· ÛÙˆ Ú¯ÛŒØ§Û” Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”");
        storyEl.textContent = "";
      }
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Ø¢Ù¾ Ú©Ø§ Ø¨Ø±Ø§Ø¤Ø²Ø± ÙˆØ§Ø¦Ø³ Ø§Ù† Ù¾Ù¹ Ø³Ù¾ÙˆØ±Ù¹ Ù†ÛÛŒÚº Ú©Ø±ØªØ§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Chrome/Edge Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚºÛ”");
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "ur-PK";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      micBtn.classList.add("glow");
      listenHint.style.display = "block";
      rec.start();

      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        titleEl.value = txt;
      };
      rec.onerror = () => {
        alert("Ø¢ÙˆØ§Ø² Ø³Ù†Ù†Û’ Ù…ÛŒÚº Ù…Ø³Ø¦Ù„Û Ø¢ÛŒØ§Û” Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”");
      };
      rec.onend = () => {
        micBtn.classList.remove("glow");
        listenHint.style.display = "none";
      };
    }
  </script>
</body>
</html>
