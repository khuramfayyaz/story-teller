<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>اردو کہانی سنانے والا</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    input, button { padding: 10px; margin: 6px; font-size: 1rem; }
    #storyText { margin-top: 18px; font-size: 1.15rem; white-space: pre-wrap; }
    .mic-btn { border: none; background: none; font-size: 2.2rem; cursor: pointer; margin: 10px; }
    .mic-btn.glow { color: #e11d48; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { text-shadow: 0 0 6px #e11d48; } 50% { text-shadow: 0 0 24px #e11d48; } 100% { text-shadow: 0 0 6px #e11d48; } }
    .muted { opacity: 0.7; }
  </style>
</head>
<body>
  <h2>اپنی کہانی کا عنوان درج کریں یا بولیں</h2>

  <input type="text" id="title" placeholder="کہانی کا عنوان لکھیں" />
  <button id="genBtn">کہانی بنائیں</button>
  <br />
  <button class="mic-btn" id="micBtn" title="بولیں">🎤</button>
  <div id="listenHint" class="muted" style="display:none;">🔊 سن رہا ہوں…</div>

  <h3>📖 کہانی</h3>
  <div id="storyText"></div>

  <h3>🔊 آڈیو</h3>
  <audio id="storyAudio" controls></audio>

  <script>
    const backendUrl = "http://3.91.184.138:8000";

    const titleEl = document.getElementById("title");
    const storyEl = document.getElementById("storyText");
    const audioEl = document.getElementById("storyAudio");
    const micBtn  = document.getElementById("micBtn");
    const listenHint = document.getElementById("listenHint");
    const genBtn  = document.getElementById("genBtn");

    genBtn.addEventListener("click", generateStory);
    micBtn.addEventListener("click", startListening);

    async function generateStory() {
      const title = titleEl.value.trim();
      if (!title) { alert("براہ کرم عنوان درج کریں۔"); return; }

      storyEl.textContent = "کہانی بن رہی ہے… براہ کرم انتظار کریں۔";
      audioEl.removeAttribute("src");

      const formData = new FormData();
      formData.append("title", title);

      try {
        const res = await fetch(`${backendUrl}/story`, { method: "POST", body: formData });
        if (!res.ok) throw new Error("API error " + res.status);
        const data = await res.json();

        storyEl.textContent = data.text || "(متن دستیاب نہیں)";
        audioEl.src = `${backendUrl}/audio/${data.audio}`;
        audioEl.play().catch(()=>{}); // autoplay may be blocked; user can press play
      } catch (e) {
        console.error(e);
        alert("کچھ غلط ہو گیا۔ دوبارہ کوشش کریں۔");
        storyEl.textContent = "";
      }
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("آپ کا براؤزر وائس ان پٹ سپورٹ نہیں کرتا۔ براہ کرم Chrome/Edge استعمال کریں۔");
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "ur-PK";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      micBtn.classList.add("glow");
      listenHint.style.display = "block";
      rec.start();

      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        titleEl.value = txt;
      };
      rec.onerror = () => {
        alert("آواز سننے میں مسئلہ آیا۔ دوبارہ کوشش کریں۔");
      };
      rec.onend = () => {
        micBtn.classList.remove("glow");
        listenHint.style.display = "none";
      };
    }
  </script>
</body>
</html>
